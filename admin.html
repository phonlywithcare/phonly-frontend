<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phonly Admin Dashboard</title>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #f5f5f5;
}
.hidden { display: none; }

.login-box, .dashboard {
  padding: 20px;
  max-width: 900px;
  margin: auto;
}

input, button, select {
  padding: 10px;
  margin: 5px 0;
  width: 100%;
}

button {
  background: #18a51a;
  color: white;
  border: none;
  cursor: pointer;
  font-weight: bold;
}
button:hover { opacity: 0.9; }

.table-box {
  margin-top: 20px;
  background: white;
  padding: 15px;
  border-radius: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #ddd;
}

.manage-btn {
  background: #0066ff;
}

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #222;
  color: #fff;
  padding: 12px 20px;
  border-radius: 6px;
  opacity: 0;
  transition: 0.3s;
  z-index: 9999;
}

.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center; align-items: center;
}
.modal-box {
  background: white;
  padding: 20px;
  width: 350px;
  border-radius: 10px;
}
</style>
</head>
<body>

<!-- ================= LOGIN SCREEN ================= -->
<div id="loginScreen" class="login-box">
  <h2>Admin Login</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboardScreen" class="dashboard hidden">

  <h2>ðŸ“Š Booking Dashboard</h2>
  <button onclick="logout()" style="background:#ff3b3b;">Logout</button>

  <div class="table-box">
    <h3>All Bookings</h3>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Service</th>
          <th>Status</th>
          <th>Manage</th>
        </tr>
      </thead>
      <tbody id="bookingTable"></tbody>
    </table>
  </div>

</div>

<!-- ================= MODAL ================= -->
<div id="manageModal" class="modal">
  <div class="modal-box">
    <h3>Manage Booking</h3>
    <p><b>Name:</b> <span id="mName"></span></p>
    <p><b>Phone:</b> <span id="mPhone"></span></p>
    <p><b>Service:</b> <span id="mService"></span></p>
    <p><b>Address:</b> <span id="mAddress"></span></p>
    <p><b>Date:</b> <span id="mDate"></span></p>

    <label>Status</label>
    <select id="statusSelect">
      <option>Pending</option>
      <option>In Progress</option>
      <option>Completed</option>
    </select>

    <button onclick="updateStatus()">Update</button>
    <button onclick="closeModal()" style="background:#555;">Close</button>
  </div>
</div>

<!-- ================= JS SCRIPT ================= -->
<script>
const API = "https://backendwithapi.onrender.com";

let selectedBookingId = null;

// ========== Show Toast ==========
function showToast(msg){
  const t = document.createElement("div");
  t.className = "toast";
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity = 1; },100);
  setTimeout(()=>{ t.style.opacity = 0; t.remove(); },2500);
}

// ========== LOGIN ==========
async function login(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const res = await fetch(`${API}/api/admin/login`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({email, password})
  });

  const data = await res.json();

  if(data.success){
    localStorage.setItem("admin","true");
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("dashboardScreen").classList.remove("hidden");
    loadBookings();
  } else {
    showToast("Invalid Login");
  }
}

// ========== LOGOUT ==========
function logout(){
  localStorage.removeItem("admin");
  location.reload();
}

// ========== LOAD BOOKINGS ==========
async function loadBookings(){
  const res = await fetch(`${API}/api/bookings`);
  const bookings = await res.json();

  const table = document.getElementById("bookingTable");
  table.innerHTML = "";

  bookings.forEach(b=>{
    table.innerHTML += `
      <tr>
        <td>${b.bookingId}</td>
        <td>${b.name}</td>
        <td>${b.phone}</td>
        <td>${b.service}</td>
        <td>${b.status}</td>
        <td>
          <button class="manage-btn" onclick='openModal(${JSON.stringify(b)})'>Manage</button>
        </td>
      </tr>`;
  });
}

// ========== OPEN MODAL ==========
function openModal(b){
  selectedBookingId = b._id;

  document.getElementById("mName").innerText = b.name;
  document.getElementById("mPhone").innerText = b.phone;
  document.getElementById("mService").innerText = b.service;
  document.getElementById("mAddress").innerText = b.address;
  document.getElementById("mDate").innerText = b.datetime;

  document.getElementById("statusSelect").value = b.status;

  document.getElementById("manageModal").style.display = "flex";
}

// ========== CLOSE MODAL ==========
function closeModal(){
  document.getElementById("manageModal").style.display = "none";
}

// ========== UPDATE STATUS ==========
async function updateStatus(){
  const status = document.getElementById("statusSelect").value;

  await fetch(`${API}/api/bookings/${selectedBookingId}`, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ status })
  });

  showToast("Status Updated");
  closeModal();
  loadBookings();
}

// ========== REAL-TIME ALERTS ==========
let lastCount = 0;
let sound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

setInterval(async ()=>{
  const res = await fetch(`${API}/api/bookings`);
  const data = await res.json();

  if (data.length > lastCount){
    let newCount = data.length - lastCount;
    showToast(`ðŸ”” ${newCount} New Booking!`);
    sound.play();
    loadBookings();
  }

  lastCount = data.length;

}, 8000); // every 8 seconds

// ========== AUTO LOGIN IF SESSION EXISTS ==========
if(localStorage.getItem("admin")){
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("dashboardScreen").classList.remove("hidden");
  loadBookings();
}
</script>

</body>
</html>
